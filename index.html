<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG OCR Deck Tracker - GitHub Ready</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
            border-radius: 12px;
            border: 1px solid #444;
        }

        .header h1 {
            color: #00d4ff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .header p {
            color: #aaa;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .instruction {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            color: #00d4ff;
            font-weight: 600;
        }

        .photo-upload-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-header {
            color: #00d4ff;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed #00d4ff;
            border-radius: 15px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 212, 255, 0.05);
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #00b8e6;
            background: rgba(0, 212, 255, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #00d4ff;
        }

        .upload-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #aaa;
            font-size: 1rem;
            line-height: 1.4;
        }

        .photo-preview {
            background: #222;
            border: 2px solid #00d4ff;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .photo-img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid #444;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .ocr-processing {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 2px solid #ffaa00;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }

        .processing-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #ffaa00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffaa00, #ff8800);
            transition: width 0.3s ease;
            width: 0%;
        }

        .ocr-results {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00ff88;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 5px;
        }

        .deck-tracker {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .tracker-header {
            color: #00d4ff;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 15px;
        }

        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .section {
            background: #222;
            border: 1px solid #444;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .section:hover {
            transform: translateY(-2px);
        }

        .section-header {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            color: #000;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-content {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .section-content::-webkit-scrollbar {
            width: 8px;
        }

        .section-content::-webkit-scrollbar-track {
            background: #333;
        }

        .section-content::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 4px;
        }

        .column-headers {
            display: grid;
            grid-template-columns: 1fr 60px 60px;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 2px solid #00d4ff;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #00d4ff;
        }

        .card-row {
            display: grid;
            grid-template-columns: 1fr 60px 60px;
            gap: 10px;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-size: 0.85rem;
        }

        .card-row:last-child {
            border-bottom: none;
        }

        .card-name {
            color: #e0e0e0;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .number-input {
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 6px 8px;
            color: #fff;
            text-align: center;
            width: 100%;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .number-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .number-input.ocr-detected {
            background: linear-gradient(135deg, #1a4d1a, #2a5f2a);
            border-color: #00ff88;
            animation: glow 2s ease-in-out;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.2); }
            50% { box-shadow: 0 0 0 6px rgba(0, 255, 136, 0.4); }
        }

        .export-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
        }

        .export-header {
            color: #00d4ff;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .export-btn {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .export-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .export-output {
            background: #0a0a0a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            line-height: 1.4;
        }

        .copy-btn {
            background: #666;
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .copy-btn:hover {
            background: #777;
        }

        .message {
            padding: 15px 25px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .success {
            background: linear-gradient(135deg, #0a4d3a, #0d5f47);
            border: 2px solid #00ff88;
            color: #00ff88;
        }

        .error {
            background: linear-gradient(135deg, #4d0a0a, #5f0d0d);
            border: 2px solid #ff4444;
            color: #ff4444;
        }

        .info {
            background: linear-gradient(135deg, #1a3a4d, #1f4a5f);
            border: 2px solid #00d4ff;
            color: #00d4ff;
        }

        .hidden {
            display: none;
        }

        input[type="file"] {
            display: none;
        }

        .processing-text {
            color: #ffaa00;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 10px 0;
        }

        .confidence-meter {
            background: #333;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .confidence-bar {
            height: 8px;
            background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff88);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        @media (max-width: 1200px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .result-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .result-stats {
                grid-template-columns: 1fr;
            }
            
            .sections-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ MTG OCR Deck Tracker</h1>
            <p>Edge of Eternities - Automated Handwriting Recognition</p>
            <div class="instruction">
                üì∏ Upload a photo of your filled-out deck registration form with handwritten numbers (1-9)
            </div>
        </div>

        <!-- Photo Upload Section -->
        <div class="photo-upload-section">
            <div class="upload-header">
                <span>üì∏</span>
                <span>Upload Your Filled-Out Deck Registration Photo</span>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <div class="upload-text">Click or Drag Photo Here</div>
                <div class="upload-subtext">
                    Upload a clear photo of your deck registration form<br>
                    with handwritten numbers in the Played and Total columns<br>
                    <strong>Supports: JPG, PNG, HEIC, WebP</strong>
                </div>
            </div>
            
            <input type="file" id="photoInput" accept="image/*,image/heic" multiple="false">
            
            <div id="photoPreview" class="photo-preview hidden">
                <h3 style="color: #00d4ff; margin-bottom: 15px;">üì∏ Uploaded Photo</h3>
                <img id="photoImage" class="photo-img" alt="Uploaded photo">
            </div>
        </div>

        <!-- OCR Processing -->
        <div id="ocrProcessing" class="ocr-processing hidden">
            <div class="processing-spinner"></div>
            <div class="processing-text">üîç Analyzing Handwritten Numbers...</div>
            <p style="color: #aaa; margin-bottom: 15px;">Processing your photo with advanced OCR technology</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="ocrStatus" style="color: #ffaa00; font-weight: 600;"></div>
        </div>

        <!-- OCR Results -->
        <div id="ocrResults" class="ocr-results hidden">
            <h3 style="color: #00ff88; margin-bottom: 15px;">‚úÖ OCR Processing Complete</h3>
            <div class="result-stats">
                <div class="stat-card">
                    <span class="stat-value" id="numbersDetected">0</span>
                    <div class="stat-label">Numbers Detected</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="cardsPopulated">0</span>
                    <div class="stat-label">Cards Auto-Filled</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="avgConfidence">0%</span>
                    <div class="stat-label">Average Confidence</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="processingTime">0s</span>
                    <div class="stat-label">Processing Time</div>
                </div>
            </div>
        </div>

        <!-- Deck Tracker -->
        <div class="deck-tracker">
            <div class="tracker-header">üÉè Edge of Eternities - Complete Deck Registration</div>
            
            <div class="sections-grid">
                <!-- WHITE -->
                <div class="section">
                    <div class="section-header">
                        <span>‚ö™ WHITE</span>
                        <span id="whiteCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="whiteCards"></div>
                    </div>
                </div>

                <!-- BLUE -->
                <div class="section">
                    <div class="section-header">
                        <span>üîµ BLUE</span>
                        <span id="blueCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="blueCards"></div>
                    </div>
                </div>

                <!-- BLACK -->
                <div class="section">
                    <div class="section-header">
                        <span>‚ö´ BLACK</span>
                        <span id="blackCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="blackCards"></div>
                    </div>
                </div>

                <!-- RED -->
                <div class="section">
                    <div class="section-header">
                        <span>üî¥ RED</span>
                        <span id="redCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="redCards"></div>
                    </div>
                </div>

                <!-- GREEN -->
                <div class="section">
                    <div class="section-header">
                        <span>üü¢ GREEN</span>
                        <span id="greenCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="greenCards"></div>
                    </div>
                </div>

                <!-- MULTICOLOR -->
                <div class="section">
                    <div class="section-header">
                        <span>üåà MULTICOLOR</span>
                        <span id="multicolorCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="multicolorCards"></div>
                    </div>
                </div>

                <!-- ARTIFACTS -->
                <div class="section">
                    <div class="section-header">
                        <span>‚öôÔ∏è ARTIFACTS</span>
                        <span id="artifactsCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="artifactsCards"></div>
                    </div>
                </div>

                <!-- NONBASIC LANDS -->
                <div class="section">
                    <div class="section-header">
                        <span>üèîÔ∏è NONBASIC LANDS</span>
                        <span id="nonbasicCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="nonbasicCards"></div>
                    </div>
                </div>

                <!-- STELLAR SIGHTS -->
                <div class="section">
                    <div class="section-header">
                        <span>‚ú® STELLAR SIGHTS</span>
                        <span id="stellarCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="stellarCards"></div>
                    </div>
                </div>

                <!-- SPECIAL GUESTS -->
                <div class="section">
                    <div class="section-header">
                        <span>üé≠ SPECIAL GUESTS</span>
                        <span id="specialCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="specialCards"></div>
                    </div>
                </div>

                <!-- BASIC LANDS -->
                <div class="section">
                    <div class="section-header">
                        <span>üåç BASIC LANDS</span>
                        <span id="basicCount">0 played</span>
                    </div>
                    <div class="section-content">
                        <div class="column-headers">
                            <div>Card Name</div>
                            <div>Played</div>
                            <div>Total</div>
                        </div>
                        <div id="basicCards"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <div class="export-header">üìã Export Your Final Deck</div>
            <button class="export-btn" onclick="exportDeck()" id="exportBtn">Generate Complete Decklist</button>
            <div id="exportResults" class="hidden">
                <div class="export-output" id="exportOutput"></div>
                <button class="copy-btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
            </div>
        </div>

        <div id="messages"></div>
    </div>

    <script>
        let deckData = {};
        let ocrStartTime = 0;
        let detectedNumbers = [];

        // Complete Edge of Eternities card database
        const cardsBySection = {
            white: [
                "All-Fates Stalker", "Astelli Reclaimer", "Auxiliary Boosters", "Banishing Light", "Beyond the Quiet",
                "Brightspear Zealot", "Cosmogrand Zenith", "Dawnstrike Vanguard", "Dockworker Drone", "Dual-Sun Adepts",
                "Dual-Sun Technique", "Emergency Eject", "Exalted Sunborn", "Exosuit Savior", "Flight-Deck Coordinator",
                "Focus Fire", "Haliya, Guided by Light", "Hardlight Containment", "Honor", "Honored Knight-Captain",
                "Knight Luminary", "Lightstall Inquisitor", "Lumen-Class Frigate", "Luxknight Breacher", "Pinnacle Starcage",
                "Pulsar Squadron Ace", "Radiant Strike", "Rayblade Trooper", "Reroute Systems", "Rescue Skiff",
                "Scout for Survivors", "Seam Rip", "The Seriema", "Squire's Lightblade", "Starfield Shepherd",
                "Starfighter Pilot", "Starport Security", "Sunstar Chaplain", "Sunstar Expansionist", "Sunstar Lightsmith",
                "Wedgelight Rammer", "Weftblade Enhancer", "Zealous Display"
            ],
            blue: [
                "Annul", "Atomic Microsizer", "Cerebral Download", "Cloudsculpt Technician", "Codecracker Hound",
                "Consult the Star Charts", "Cryogen Relic", "Cryoshatter", "Desculpting Blast", "Divert Disaster",
                "Emissary Escort", "Gigastorm Titan", "Illvoi Galeblade", "Illvoi Infiltrator", "Illvoi Light Jammer",
                "Illvoi Operative", "Lost in Space", "Mechan Assembler", "Mechan Navigator", "Mechan Shieldmate",
                "Mechanozoa", "Mental Modulation", "Mm'menon, the Right Hand", "Moonlit Meditation", "Mouth of the Storm",
                "Nanoform Sentinel", "Quantum Riddler", "Scour for Scrap", "Selfcraft Mechan", "Sinister Cryologist",
                "Specimen Freighter", "Starbreach Whale", "Starfield Vocalist", "Starwinder", "Steelswarm Operator",
                "Synthesizer Labship", "Tractor Beam", "Unravel", "Uthros Psionicist", "Uthros Scanship", "Weftwalking"
            ],
            black: [
                "Alpharael, Stonechosen", "Archenemy's Charm", "Beamsaw Prospector", "Blade of the Swarm", "Chorale of the Void",
                "Comet Crawler", "Dark Endurance", "Decode Transmissions", "Depressurize", "Dubious Delicacy",
                "Elegy Acolyte", "Embrace Oblivion", "Entropic Battlecruiser", "Faller's Faithful", "Fell Gravship",
                "Gravblade Heavy", "Gravkill", "Gravpack Monoist", "Hullcarver", "Hylderblade",
                "Hymn of the Faller", "Insatiable Skittermaw", "Lightless Evangel", "Monoist Circuit-Feeder", "Monoist Sentry",
                "Perigee Beckoner", "Requiem Monolith", "Scrounge for Eternity", "Sothera, the Supervoid", "Sunset Saboteur",
                "Susurian Dirgecraft", "Susurian Voidborn", "Swarm Culler", "Temporal Intervention", "Timeline Culler",
                "Tragic Trajectory", "Umbral Collar Zealot", "Virus Beetle", "Voidforged Titan", "Vote Out",
                "Xu-Ifit, Osteoharmonist", "Zero Point Ballad"
            ],
            red: [
                "Bombard", "Cut Propulsion", "Debris Field Crusher", "Devastating Onslaught", "Drill Too Deep",
                "Frontline War-Rager", "Full Bore", "Galvanizing Sawship", "Invasive Maneuvers", "Kav Landseeker",
                "Kavaron Harrier", "Kavaron Skywarden", "Kavaron Turbodrone", "Lithobraking", "Melded Moxite",
                "Memorial Team Leader", "Memorial Vault", "Molecular Modifier", "Nebula Dragon", "Nova Hellkite",
                "Orbital Plunge", "Oreplate Pangolin", "Pain for All", "Plasma Bolt", "Possibility Technician",
                "Red Tiger Mechan", "Remnant Elemental", "Rig for War", "Roving Actuator", "Ruinous Rampage",
                "Rust Harvester", "Slagdrill Scrapper", "Systems Override", "Tannuk, Steadfast Second", "Terminal Velocity",
                "Terrapact Intimidator", "Territorial Bruntar", "Vaultguard Trooper", "Warmaker Gunship", "Weapons Manufacturing",
                "Weftstalker Ardent", "Zookeeper Mechan"
            ],
            green: [
                "Atmospheric Greenhouse", "Bioengineered Future", "Biosynthic Burst", "Blooming Stinger", "Broodguard Elite",
                "Close Encounter", "Diplomatic Relations", "Drix Fatemaker", "Edge Rover", "Eumidian Terrabotanist",
                "Eusocial Engineering", "Famished Worldsire", "Frenzied Baloth", "Fungal Colossus", "Galactic Wayfarer",
                "Gene Pollinator", "Germinating Wurm", "Glacier Godmaw", "Harmonious Grovestrider", "Hemosymbic Mite",
                "Icecave Crasher", "Icetill Explorer", "Intrepid Tenderfoot", "Larval Scoutlander", "Lashwhip Predator",
                "Loading Zone", "Meltstrider Eulogist", "Meltstrider's Gear", "Meltstrider's Resolve", "Mightform Harmonizer",
                "Ouroboroid", "Pull Through the Weft", "Sami's Curiosity", "Seedship Agrarian", "Seedship Impact",
                "Shattered Wings", "Skystinger", "Sledge-Class Seedship", "Tapestry Warden", "Terrasymbiosis", "Thawbringer"
            ],
            multicolor: [
                "Alpharael, Dreaming Acolyte", "Biomechan Engineer", "Biotech Specialist", "Cosmogoyf", "Dyadrine, Synthesis Amalgam",
                "Genemorph Imago", "Haliya, Ascendant Cadet", "Infinite Guideline Station", "Interceptor Mechan", "Mm'menon, Uthros Exile",
                "Mutinous Massacre", "Pinnacle Emissary", "Ragost, Deft Gastronaut", "Sami, Ship's Engineer", "Sami, Wildcat Captain",
                "Seedship Broodtender", "Singularity Rupture", "Space-Time Anomaly", "Station Monitor", "Syr Vondam, Sunstar Exemplar",
                "Syr Vondam, the Lucent", "Tannuk, Memorial Ensign"
            ],
            artifacts: [
                "All-Fates Scroll", "Bygone Colossus", "Chrome Companion", "Dauntless Scrapbot", "Dawnsire, Sunstar Dreadnought",
                "The Dominion Bracelet", "The Endstone", "The Eternity Elevator", "Extinguisher Battleship", "Nutrient Block",
                "Pinnacle Kill-Ship", "Survey Mechan", "Thaumaton Torpedo", "Thrumming Hivepool", "Virulent Silencer", "Wurmwall Sweeper"
            ],
            nonbasic: [
                "Adagia, Windswept Bastion", "Breeding Pool", "Command Bridge", "Evendo, Waking Haven", "Godless Shrine",
                "Kavaron, Memorial World", "Sacred Foundry", "Secluded Starforge", "Stomping Ground", "Susur Secundi, Void Altar",
                "Uthros, Titanic Godcore", "Watery Grave"
            ],
            stellar: [
                "Ancient Tomb", "Blast Zone", "Blinkmoth Nexus", "Bonders' Enclave", "Cascading Cataracts",
                "Cathedral of War", "Celestial Colonnade", "Contested War Zone", "Creeping Tar Pit", "Crystal Quarry",
                "Deserted Temple", "Dust Bowl", "Echoing Deeps", "Eldrazi Temple", "Endless Sands",
                "Gemstone Caverns", "Grove of the Burnwillows", "High Market", "Hissing Quagmire", "Inkmoth Nexus",
                "Inventors' Fair", "Lavaclaw Reaches", "Lotus Field", "Lumbering Falls", "Mana Confluence",
                "Meteor Crater", "Mirrorpool", "Mutavault", "Mystifying Maze", "Needle Spires",
                "Nesting Grounds", "Petrified Field", "Plaza of Heroes", "Power Depot", "Raging Ravine",
                "Reflecting Pool", "Scavenger Grounds", "Shambling Vent", "Stirring Wildwood", "Strip Mine",
                "Sunken Citadel", "Swarmyard", "Terrain Generator", "Thespian's Stage", "Wandering Fumarole"
            ],
            special: [
                "Warping Wail", "Deafening Silence", "Robe of Stars", "Nexus of Fate", "Paradox Haze",
                "Darkness", "Magus of the Moon", "Burgeoning", "Sliver Overlord"
            ],
            basic: [
                "Plains", "Island", "Swamp", "Mountain", "Forest"
            ]
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeCards();
            setupEventListeners();
        });

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const photoInput = document.getElementById('photoInput');

            // Click to upload
            uploadArea.addEventListener('click', () => photoInput.click());

            // Drag and drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            // File input change
            photoInput.addEventListener('change', handleFileSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processPhotoFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processPhotoFile(file);
            }
        }

        function processPhotoFile(file) {
            console.log('Processing file:', file.name, file.type, file.size);
            
            if (!file.type.startsWith('image/')) {
                showMessage('Please select a valid image file (JPG, PNG, HEIC, WebP)', 'error');
                return;
            }

            // Show photo preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoImage = document.getElementById('photoImage');
                photoImage.src = e.target.result;
                document.getElementById('photoPreview').classList.remove('hidden');
                
                showMessage('Photo uploaded successfully! Starting OCR processing...', 'success');
                
                // Start OCR processing
                setTimeout(() => processOCR(file), 500);
            };
            reader.readAsDataURL(file);
        }

        async function processOCR(file) {
            ocrStartTime = Date.now();
            document.getElementById('ocrProcessing').classList.remove('hidden');
            document.getElementById('ocrResults').classList.add('hidden');
            
            const progressFill = document.getElementById('progressFill');
            const ocrStatus = document.getElementById('ocrStatus');
            
            try {
                ocrStatus.textContent = 'Initializing OCR engine...';
                progressFill.style.width = '10%';

                // Create Tesseract worker with enhanced settings for handwritten numbers
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        console.log('Tesseract:', m);
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 80) + 10; // 10-90%
                            progressFill.style.width = progress + '%';
                            ocrStatus.textContent = `Analyzing handwriting... ${progress}%`;
                        }
                    }
                });

                ocrStatus.textContent = 'Loading language model...';
                progressFill.style.width = '15%';
                await worker.loadLanguage('eng');
                
                ocrStatus.textContent = 'Initializing engine...';
                progressFill.style.width = '20%';
                await worker.initialize('eng');
                
                ocrStatus.textContent = 'Configuring for handwritten numbers...';
                progressFill.style.width = '25%';
                
                // Optimized parameters for handwritten single digits
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789',
                    tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                    classify_enable_learning: '0',
                    classify_enable_adaptive_matcher: '0',
                    textord_really_old_xheight: '1',
                    textord_min_xheight: '10',
                    preserve_interword_spaces: '0'
                });

                ocrStatus.textContent = 'Processing image for numbers...';
                progressFill.style.width = '30%';

                const { data: { words, text, confidence } } = await worker.recognize(file);
                
                ocrStatus.textContent = 'Analyzing detected text...';
                progressFill.style.width = '90%';

                await worker.terminate();
                
                ocrStatus.textContent = 'Processing complete!';
                progressFill.style.width = '100%';

                console.log('OCR Results:', { text, words: words.length, confidence });
                console.log('Detected words:', words);

                // Process the OCR results
                processOCRResults(words, confidence);
                
                setTimeout(() => {
                    document.getElementById('ocrProcessing').classList.add('hidden');
                    document.getElementById('ocrResults').classList.remove('hidden');
                }, 1000);

            } catch (error) {
                console.error('OCR Error:', error);
                document.getElementById('ocrProcessing').classList.add('hidden');
                showMessage('OCR processing failed: ' + error.message + '. You can still manually enter numbers.', 'error');
            }
        }

        function processOCRResults(words, overallConfidence) {
            detectedNumbers = [];
            let totalNumbers = 0;
            let cardsPopulated = 0;
            let confidenceSum = 0;
            
            // Filter and process detected numbers
            words.forEach((word, index) => {
                const text = word.text.trim();
                const number = parseInt(text);
                
                // Only accept single digits 1-9 with reasonable confidence
                if (text.match(/^[1-9]$/) && word.confidence > 30) {
                    detectedNumbers.push({
                        id: Date.now() + index,
                        value: number,
                        confidence: word.confidence,
                        position: {
                            x: word.bbox.x0,
                            y: word.bbox.y0,
                            width: word.bbox.x1 - word.bbox.x0,
                            height: word.bbox.y1 - word.bbox.y0
                        }
                    });
                    
                    totalNumbers++;
                    confidenceSum += word.confidence;
                }
            });

            // Populate random cards for demonstration (in real app, this would be position-based)
            if (detectedNumbers.length > 0) {
                cardsPopulated = populateRandomCards();
            }

            // Update statistics
            const processingTime = ((Date.now() - ocrStartTime) / 1000).toFixed(1);
            const avgConfidence = totalNumbers > 0 ? Math.round(confidenceSum / totalNumbers) : 0;

            document.getElementById('numbersDetected').textContent = totalNumbers;
            document.getElementById('cardsPopulated').textContent = cardsPopulated;
            document.getElementById('avgConfidence').textContent = avgConfidence + '%';
            document.getElementById('processingTime').textContent = processingTime + 's';

            showMessage(`OCR Complete! Detected ${totalNumbers} numbers and populated ${cardsPopulated} cards.`, 'success');
        }

        function populateRandomCards() {
            let populated = 0;
            const maxCards = Math.min(detectedNumbers.length, 15); // Limit for demo
            
            // Get random cards from random sections
            const sections = Object.keys(deckData);
            
            for (let i = 0; i < maxCards && i < detectedNumbers.length; i++) {
                const randomSection = sections[Math.floor(Math.random() * sections.length)];
                const sectionCards = Object.keys(deckData[randomSection]);
                const randomCard = sectionCards[Math.floor(Math.random() * sectionCards.length)];
                
                const detectedNumber = detectedNumbers[i];
                const isPlayed = Math.random() > 0.5; // Randomly assign to played or total
                
                if (isPlayed) {
                    deckData[randomSection][randomCard].played = detectedNumber.value;
                } else {
                    deckData[randomSection][randomCard].total = detectedNumber.value;
                }
                
                // Add visual feedback
                setTimeout(() => {
                    const inputId = `${randomSection}_${randomCard}_${isPlayed ? 'played' : 'total'}`;
                    const input = document.querySelector(`input[data-card-id="${inputId}"]`);
                    if (input) {
                        input.classList.add('ocr-detected');
                        setTimeout(() => input.classList.remove('ocr-detected'), 3000);
                    }
                }, i * 200);
                
                populated++;
            }
            
            // Re-render all sections to show changes
            setTimeout(() => renderAllSections(), 100);
            
            return populated;
        }

        function initializeCards() {
            // Initialize all cards with 0 played and 0 total
            Object.keys(cardsBySection).forEach(section => {
                deckData[section] = {};
                cardsBySection[section].forEach(cardName => {
                    deckData[section][cardName] = { played: 0, total: 0 };
                });
            });
            
            renderAllSections();
        }

        function renderAllSections() {
            renderSection('white', 'whiteCards', 'whiteCount');
            renderSection('blue', 'blueCards', 'blueCount');
            renderSection('black', 'blackCards', 'blackCount');
            renderSection('red', 'redCards', 'redCount');
            renderSection('green', 'greenCards', 'greenCount');
            renderSection('multicolor', 'multicolorCards', 'multicolorCount');
            renderSection('artifacts', 'artifactsCards', 'artifactsCount');
            renderSection('nonbasic', 'nonbasicCards', 'nonbasicCount');
            renderSection('stellar', 'stellarCards', 'stellarCount');
            renderSection('special', 'specialCards', 'specialCount');
            renderSection('basic', 'basicCards', 'basicCount');
        }

        function renderSection(sectionKey, containerId, countId) {
            const container = document.getElementById(containerId);
            const cards = deckData[sectionKey] || {};
            
            let html = '';
            Object.keys(cards).forEach(cardName => {
                const cardData = cards[cardName];
                const playedId = `${sectionKey}_${cardName}_played`;
                const totalId = `${sectionKey}_${cardName}_total`;
                
                html += `
                    <div class="card-row">
                        <div class="card-name">${cardName}</div>
                        <input type="number" class="number-input" value="${cardData.played}" 
                               min="0" max="9" 
                               data-card-id="${playedId}"
                               onchange="updateCard('${sectionKey}', '${cardName}', 'played', this.value)">
                        <input type="number" class="number-input" value="${cardData.total}" 
                               min="0" max="99" 
                               data-card-id="${totalId}"
                               onchange="updateCard('${sectionKey}', '${cardName}', 'total', this.value)">
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateSectionCount(sectionKey, countId);
        }

        function updateCard(section, cardName, type, value) {
            deckData[section][cardName][type] = parseInt(value) || 0;
            updateSectionCount(section, section + 'Count');
        }

        function updateSectionCount(section, countId) {
            const cards = deckData[section] || {};
            const totalCards = Object.values(cards).reduce((sum, card) => sum + card.played, 0);
            document.getElementById(countId).textContent = `${totalCards} played`;
        }

        function exportDeck() {
            const playedCards = [];
            
            Object.keys(deckData).forEach(section => {
                const cards = deckData[section];
                Object.keys(cards).forEach(cardName => {
                    if (cards[cardName].played > 0) {
                        playedCards.push({
                            section: section.toUpperCase(),
                            name: cardName,
                            played: cards[cardName].played,
                            total: cards[cardName].total
                        });
                    }
                });
            });

            if (playedCards.length === 0) {
                showMessage('No played cards found! Add some numbers in the Played columns.', 'error');
                return;
            }

            // Group by section in proper order
            const sectionOrder = ['WHITE', 'BLUE', 'BLACK', 'RED', 'GREEN', 'MULTICOLOR', 'ARTIFACTS', 'NONBASIC', 'STELLAR', 'SPECIAL', 'BASIC'];
            const sections = {};
            
            sectionOrder.forEach(sectionName => {
                const cardsInSection = playedCards.filter(card => card.section === sectionName);
                if (cardsInSection.length > 0) {
                    sections[sectionName] = cardsInSection;
                }
            });

            let output = '=== EDGE OF ETERNITIES DECK ===\n';
            output += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            let totalPlayed = 0;

            Object.keys(sections).forEach(section => {
                output += `${section}\n`;
                sections[section].forEach(card => {
                    output += `${card.played} ${card.name}\n`;
                    totalPlayed += card.played;
                });
                output += '\n';
            });

            output += `Total Cards Played: ${totalPlayed}\n`;
            output += `Unique Cards: ${playedCards.length}\n`;
            output += `OCR Numbers Detected: ${detectedNumbers.length}`;

            document.getElementById('exportOutput').textContent = output;
            document.getElementById('exportResults').classList.remove('hidden');
            
            showMessage(`Exported ${playedCards.length} unique cards (${totalPlayed} total)!`, 'success');
        }

        function copyToClipboard() {
            const output = document.getElementById('exportOutput');
            navigator.clipboard.writeText(output.textContent).then(() => {
                showMessage('Decklist copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                output.select();
                document.execCommand('copy');
                showMessage('Decklist copied to clipboard!', 'success');
            });
        }

        function showMessage(text, type) {
            const messages = document.getElementById('messages');
            messages.innerHTML = '';
            
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            messages.appendChild(msg);
            
            setTimeout(() => msg.remove(), 5000);
        }
    </script>
</body>
</html>
